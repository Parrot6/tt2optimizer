<html>
    <!--🦍💎 🍌 Buy, Hodl 🍌 💎 🦍-->
    <!--Author: Parrot6
        Discord: Parrot6#7225
        Reddit: u/Killerparrot6
    -->
    <head>
        <title>TT2 SP Optimizer</title>
        <link rel="stylesheet" href="assets/app.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>

    <body>
        <div class="row no-gutters">
            <div class="col-12 col-md-10 no-gutters">
                <div class="row no-gutters grid2x2">
                    <div id="knightTree" class="col-6 col-sm-6 no-gutters  box box1">
                    </div>
                    <div id="warlordTree" class="col-6 col-sm-6 no-gutters  box box2">
                    </div>
                </div>
                <div class="row no-gutters grid2x2">
                <div id="sorcererTree" class="col-6 col-sm-6 no-gutters  box box3">
                </div>
                <div id="rogueTree" class="col-6 col-sm-6 no-gutters   box box4">
                    <div class="parrotInfo">
                        <span>
                        Author: Parrot6
                        Discord: Parrot6#7225
                        Reddit: u/Killerparrot6   
                        </span>
                    </div>
                </div>
                </div>

            </div>
            <div class="col-3 col-md-2 no-gutters">
                    <Strong>Skill Rankings:</Strong>
                    <div id="SkillRankings">

                    </div>
            </div>
            <div class="col-9 col-md-12 no-gutters">
                <div class="row buildTypeSection no-gutters">
                    <div class="col-2 col-sm">
                        <div class="row no-gutters">
                            <div class="col-auto alignLabelVert">
                                <label for="dmgchoices">Dmg Type:</label>
                            </div>
                            <div class="col-12 col-sm">
                                <select name="dmgchoices" id="buildDmgType">
                                </select>
                            </div>
                        </div>
                        <div class="row no-gutters">
                            <div class="col-auto alignLabelVert">
                                <label for="cars">Gold Type:</label>
                            </div>
                            <div class="col-12 col-sm">
                                <select name="goldchoices" id="buildGoldType">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="row  no-gutters">
                            <div class="col-auto alignLabelVert">
                                <label>Sp Spent:</label>
                            </div>
                            <div class="col-12 col-sm">
                                <input id="spSpent" disabled value="0"/>
                            </div>
                        </div>
                        <button class="controllerButton" onclick="resetTree()">Reset Tree</button>
                    </div>
                    <div class="col">
                        <div class="row no-gutters">
                            <div class="col-auto alignLabelVert">
                                <label>Starting Sp:</label>
                            </div>
                            <div class="col-12 col-sm">
                                <input onchange="updateStartingSp(this)" id="startingSp"/>
                            </div>
                        </div>
                        
                        
                        <button class="controllerButton" onclick="spendAllSP()">Spend All Available Sp</button>
                    </div>
    
                </div>
                <div class="row no-gutters">
                    <div class="col col-gutters">
                        <Button class="controllerButtonImport" onclick="importData(false)">Import Stats from Clipboard</Button>
                       <!--- <Button class="controllerButtonImport" onclick="importData(true)">Import Stats from Cookies (TODO)</Button> --->
                        <div class="row no-gutters">
                            <div class="col-auto alignLabelVert">
                                <label><Strong>Skills</Strong></label>
                            </div>
                            <div class="col">
                                <button id="loadSkills" onclick="loadSkillsFrom(playerSkills)" class="controllerButtonImport">Load Skills</button>
                            </div>
                            
                        </div>
                        <div id="Skills">
                            
                        </div>
                    </div>
                    <div class="col col-gutters">
                        <div><Strong>Equipment Sets</Strong>
                        <div id="EquipmentSets">
                            
                        </div>
                    </div> 
                    </div>
                    <div class="col col-gutters">
                        <div class="row no-gutters">
                            <div class="col-auto alignLabelVert">
                                <label><Strong>Statistics</Strong></label>
                            </div>
                            <div class="col">
                                <button id="loadSkills" onclick="refreshSkills()" class="controllerButtonImport">Recalc</button>
                            </div>
                        </div>
                        <div id="Probabilities">
                            
                        </div>
                    </div>
                    <div class="col col-gutters">
                        <div id="Passives">
                            Passives
                        </div>
                    </div>
                    <div class="col col-gutters">                    
                        <div id="PlayerStatistics">
                            Player Stats
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </body>
    <script>
        var TreeIDTagByClass = Object.freeze({
            Knight: "knightTree",
            Warlord: "warlordTree",
            Sorcerer: "sorcererTree",
            Rogue: "rogueTree"
        });
        var SPJsonArray = [];
        var knightArray = [];
        var warlordArray = [];
        var sorcererArray = [];
        var rogueArray = [];
        var SPreductions = {};
        var Goldreductions = {};
        const Gold = Object.freeze({pHoM: "pHoM", Chesterson: "Chesterson", HoM: "HoM", All: "All", ChestersonChance: "ChestersonChance", Fairy: "Fairy", Boss: "Boss", MultiSpawn: "MultiSpawn", Stealth: "Stealth", Inactive:"Inactive"});
        const Types = Object.freeze({tap:"xTap/FS", hero:"xHero/WC", companion: "xCompanion", all:"xAll", ds:"xDS", sad:"xSAD", crit:"xCrit", critMult:"+Crit%", pet:"xPet", sc:"xSC", dagger: "xDagger", hs:"xHS", ship:"xSHIP", Gold, rogueDS: "t4RogueDS", dimshift: "xDimShift", utility: "xUtility"
        });
        const BuildDamageOptions = Object.freeze({Hero: "Hero", Tap: "Tap", Pet: "Pet", SC: "SC", HS: "HS", Ship: "Ship"});
        const BuildGoldOptions = Object.freeze({all: "All", phom: "Boss", fairy: "Fairy", chesterson: "Chesterson", inactive: "Inactive"});
        const SpecialEffieciencies = Object.freeze(["Chivalric Order", "Cleaving Strike", "Volcanic Supremacy", "Tactical Insight", "Searing Light", "Astral Awakening", "Command Supremacy", "Midas Ultimate", 
                                                    "Warcry", "Lightning Strike", "Phantom Vengeance", "Dimensional Shift", "Divine Surpremacy", "Phantom Supremacy", "Stroke Of Luck", "Anchoring Shot", "Forbidden Contract", "Dagger Storm", "Deadly Focus", "Barbaric Fury", "Flash Zip"]);
        var typeConversions = {
            ActiveAllHelperDamage: Types.hero,
            ActiveTapDamage: Types.tap,
            AllHelperDamage: Types.hero,
            BurstDamageSkillAmount: Types.hs,
            BurstDamageSkillStacksBonus: Types.hs,
            ChestAmount: Types.Gold.Chesterson,
            ClanShipDamage: Types.ship,
            ClanShipStunDamage: Types.all,
            CloakedSkipChance: Types.utility,
            CritBoostSkillAmount: Types.ds,
            CritBoostSkillStacksBonus: Types.ds,
            CritMaxDamage: Types.crit,
            DeadlyDamageCompanion: Types.ds,
            FairySpawnChance: Types.utility,
            ForbiddenContractMaxDamage: Types.all,
            GoldAll: Types.Gold.All,
            GoldBoss: Types.Gold.pHoM,
            GuidedBladeDeadlyStrikeBoost: Types.rogueDS,
            HandOfMidasSkillAmount: Types.Gold.HoM,
            HelperBoostSkillStacksBonus: Types.hero,
            HelperMultiplicativeSkillBoost: Types.utility,
            HelperQTEDamage: Types.hero,
            InspiredHelperDamage: Types.hero,
            InspiredHelperWeaken: Types.hero,
            LightningStrikeDamage: Types.all,
            ManaMonsterAmount: Types.utility,
            ManaPoolCap: Types.utility,
            ManaTapRegen: Types.utility,
            MultiMonstersMaxCount: Types.Gold.MultiSpawn,
            PetAttackQTEDamage: Types.pet,
            PetBossQTEDamage: Types.pet,
            PetDamage: Types.pet,
            ShadowCloneAllSkillBoost: Types.dimshift,
            ShadowCloneSkillAmount: Types.sc,
            ShadowCloneSkillDuration: Types.utility,
            ShadowCloneSkillStacksBonus: Types.sc,
            TapBoostSkillAmount:  Types.tap,
            TapBoostSkillStacksBonus:  Types.tap,
            TapDamage:  Types.tap,
            TapDamageFromHelpers: Types.tap,
            UltraDaggerDamage: Types.dagger,
            UltraDaggerPoisonBoost: Types.all
        }
        var nameConversions = {
            'Inspired Shot': "Searing Light",
            "Guided Blade": "Deadly Focus",
            "Soul Blade": "Dagger Storm",
            "Ultra Dagger": "Summon Dagger",
            "Phantom Vengeance" : "Phantom Supremacy",
            "Divine Blessing" : "Divine Surpremacy"
        }
        var SelectedBuildDamage = BuildDamageOptions.Ship;
        var SelectedGoldOption = BuildGoldOptions.phom;
        var heroSkills = {};
        const heroSkillsCalced = {
            AllDamage: 37,
            AllHelperDamage: 27,
            ChestAmount: 34,
            ChestChance: 0.020000000000000004,
            CritChance: 0.018000000000000002,
            CritDamage: 22,
            FairyGold: 18,
            GoldAll: 31,
            GoldBoss: 30,
            Goldx10Chance: 0.016000000000000004,
            ManaPoolCap: 135,
            ManaRegen: 3.2000000000000006,
            MeleeHelperDamage: 21,
            RangedHelperDamage: 21,
            ShadowCloneSkillAmount: 4,
            SpellHelperDamage: 21,
            TapDamage: 28,
            TapDamageFromHelpers: 0.0001
        }
        var playerSets = {
            MastersSword: true,
            "Forsaken Battlemage": true,
            "Ignus, the Volcanic Phoenix": true,
            "Ironheart, the Crackling Tiger": true,
            "Kor, the Whispering Wave": true,
            "Styxsis, the Single Touch": true,
        }
        var playerProbabilities = {
            crit : 100,
            deadly : 100,
            multispawn : 100,
            timeSpentOnBoss: 30,
            TiAdditivePerecent: 0,
            TiMultiplicativePerecent: 0,
            lightningStrikePercent: 2.0,
            lightningStrikeAttempts: 100,
        }
        var playerProfileStats = {};
        var playerSkills = {};
        var playerArtifacts = {};
        var playerPassives = {}
        var importedData = [];
        var treeSp = {
            Knight : 0,
            Warlord : 0,
            Sorcerer : 0,
            Rogue : 0
        }
        var spSpent = 0;
        var startingSp = 0;
        var TI;
        var enhancedEfficiency = true;
        var SearingLight;
        var levelUpButton;
        var levelDownButton;
        var rankingBoxRankTemplate;
        var rankingBoxNameTemplate;
        var rankingBoxValueTemplate;
        var rankingBoxRowKnight;
        var rankingBoxRowWarlord;
        var rankingBoxRowSorcerer;
        var rankingBoxRowRogue;
        async function importData(fromCookie){
            if(!fromCookie){
            const text = await navigator.clipboard.readText();
            //console.log(text);
            importedStats = JSON.parse(text);
            } else {
                importedStats = read_cookie("import-data");
                console.log(document.cookie);
            }
        

            for (var entry in playerPassives) delete playerPassives[entry];
            Passives.innerHTML = "<Strong>Passives</Strong>";
            var passives = importedStats.passiveSkills;
            Object.entries(passives).forEach(([key, value]) => {
                var newItem = document.createElement('div');
                newItem.textContent = key +": "+value;
                Passives.appendChild(newItem);
                playerPassives[key] = value;
            });
            console.log(playerPassives);

            for (var entry in playerSkills) delete playerSkills[entry];
            Skills.innerHTML = "";
            var skills = importedStats.skillTree;
            Object.entries(skills).forEach(([key, value]) => {
                var newItem = document.createElement('div');
                newItem.textContent = key +": "+value;
                Skills.appendChild(newItem);
                playerSkills[key] = value;
            });
            document.getElementById('loadSkills').style.visibility = "visible";
            console.log(playerSkills);

            for (var entry in playerArtifacts) delete playerArtifacts[entry];
            var artifacts = importedStats.artifacts;
            Object.entries(artifacts).forEach(([key, value]) => {
                playerArtifacts[key] = value;
            });
            console.log(playerArtifacts);

            var stats = importedStats.playerStats;
            PlayerStatistics.innerHTML = "<Strong>Player Stats</Strong>";
            Object.entries(stats).forEach(([key, value]) => {
                var newItem = document.createElement('div');
                newItem.textContent = key +": "+value;
                PlayerStatistics.appendChild(newItem);
                playerProfileStats[key] = value;
            });
            console.log(playerProfileStats);
            document.getElementById('startingSp').value = playerProfileStats["Skill Points Owned"];
            updateStartingSp(document.getElementById('startingSp'));

            var equips = importedStats.equipmentSets;
            for (var entry in playerSets) delete playerSets[entry];
            EquipmentSets.innerHTML = "";
            updateArtifacts();
            Object.entries(equips).forEach(([key, value]) => {
                var newItem = document.createElement('div');
                newItem.textContent = value;
                EquipmentSets.appendChild(newItem);
                playerSets[value] = true;
            });
            console.log(playerSets);
            (function(){
            var myObject = JSON.parse('{"id":1,"gender":"male"}');
            var e = 'Thu Nov 26 2017 15:44:38'; document.cookie = 'myObj='+ JSON.stringify(myObject) +';expires=' + e;
            })()
            bake_cookie("import-data", "test");
        }
        function bake_cookie(name, value) {
            var cookie = [name, '=', JSON.stringify(value), '; domain=.', window.location.host.toString(), '; path=/;'].join('');
            document.cookie = cookie;
        }
        function read_cookie(name) {
            var result = document.cookie.match(new RegExp(name + '=([^;]+)'));
            result && (result = JSON.parse(result[1]));
            return result;
        }
        function updateSkillRankingList(){
            var rankingBox = SkillRankings;
            rankingBox.innerHTML = "";
            var ul = document.createDocumentFragment();
            SPJsonArray.sort(function(a,b){
                return parseFloat(b.Efficiency) - parseFloat(a.Efficiency);
            });
            var i = 0;
            SPJsonArray.forEach((element) => {
                if(element.Efficiency <= 1 || element.Ignore || element.Level == element.MaxLevel) return;
                var li = getRowTemplate(element.Class).cloneNode(true);
                i++;
                li.onclick = ()=>{
                    levelSkill(element, 1);
                };
                li.addEventListener('mousedown', function(e){ e.preventDefault(); }, false);
                var rank = rankingBoxRankTemplate.cloneNode(true);
                rank.textContent = "#"+i;
                var Name = rankingBoxNameTemplate.cloneNode(true);
                Name.textContent = element.Name;
                var value = rankingBoxValueTemplate.cloneNode(true);
                value.textContent = Number(element.Efficiency).toFixed(4);
                li.appendChild(rank);
                li.appendChild(Name);
                li.appendChild(value);
                ul.appendChild(li);
            });
            SkillRankings.appendChild(ul);
        }
        function updateStartingSp(input){
            startingSp = Number(input.value);
        }
        $(document).ready(function() {
            $.ajax({
                type: "GET",
                url: "https://mb1zattts4.execute-api.us-east-1.amazonaws.com/dev/tt2optimizer/assets/reductions.csv",
                dataType: "text",
                success: function(data) {
                    processReductions(data);
                    $.ajax({
                    type: "GET",
                    url: "https://mb1zattts4.execute-api.us-east-1.amazonaws.com/dev/tt2optimizer/assets/goldReductions.csv",
                    dataType: "text",
                    success: function(data) {
                        processGoldReductions(data);
                        $.ajax({
                        type: "GET",
                        url: "https://mb1zattts4.execute-api.us-east-1.amazonaws.com/dev/tt2optimizer/assets/SkillTreeInfo.csv",
                        dataType: "text",
                        success: function(data) {
                            initialTreeData = data;
                            processData();
                        }
                    });
                    }
                     });
                }
            });
            
            
        //     $.ajax({
        //         type: "GET",
        //         url: "./assets/HelperSkillInfo.csv",
        //         dataType: "text",
        //         success: function(data) {processHeroSkills(data);}
        //     });
        });
        var initialTreeData = null;
        function effectColA(skillRow, levelIncrement){
                return "A"+(skillRow.Level+levelIncrement);
            }
        function effectColB(skillRow, levelIncrement){
            return "B"+(skillRow.Level+levelIncrement);
        }
        function costCol(skillRow, levelIncrement){
                return "Co"+(skillRow.Level+levelIncrement);
            }
        function spendSP(){
            var bestIndex = 0;
            for(var i = 0; i < SPJsonArray.length; i++){
                if(SPJsonArray[i].Efficiency > SPJsonArray[bestIndex].Efficiency && SPJsonArray[i].Level < SPJsonArray[i].MaxLevel) bestIndex = i;
            }
            SPJsonArray[bestIndex].Level++;
            Reload();
        }
        function spendAllSP(){
            var UpgradeAvailable = true;
            var bestIndex = 0;
            var toLevel = 0;
            while(UpgradeAvailable){
                UpgradeAvailable = false;
                    if(!SPJsonArray[bestIndex].Ignore){
                            if( SPJsonArray[bestIndex].Level < Number(SPJsonArray[bestIndex].MaxLevel)){
                                if(SPJsonArray[bestIndex][costCol(SPJsonArray[bestIndex], 0)] <= (startingSp - spSpent)){
                                    if(SPJsonArray[bestIndex].Efficiency > 1.0){
                                        if(SPJsonArray[bestIndex].SPReq <= treeSp[SPJsonArray[bestIndex].Class]){
                                                toLevel = bestIndex;    
                                                bestIndex = 0;
                                                UpgradeAvailable = true;
                                        } else {
                                            checkPrerequesites(SPJsonArray[bestIndex]);
                                            allocateBestAvailableOfTree(SPJsonArray[bestIndex].Class, SPJsonArray[bestIndex].SPReq);
                                            toLevel = bestIndex;    
                                            bestIndex = 0;
                                            UpgradeAvailable = true;
                                        }
                                    }
                                }
                            }
                    }
                if(UpgradeAvailable){
                    console.log("leveling: ", SPJsonArray[toLevel].Name);
                    checkPrerequesites(SPJsonArray[toLevel]);
                    levelSkill(SPJsonArray[toLevel], 1);
                } else if(bestIndex < SPJsonArray.length - 1){
                    bestIndex++;
                    UpgradeAvailable = true;
                }
            };
        }
        function allocateBestAvailableOfTree(thisClass, toThisSp){
            var bestIndex = 0;
            var UpgradeAvailable = true;
            while(UpgradeAvailable && treeSp[thisClass] < toThisSp){
                UpgradeAvailable = false;
                if(!SPJsonArray[bestIndex].Ignore){
                    if(SPJsonArray[bestIndex].Class == thisClass){
                        if(SPJsonArray[bestIndex].SPReq <= treeSp[SPJsonArray[bestIndex].Class]){
                            if( SPJsonArray[bestIndex].Level < Number(SPJsonArray[bestIndex].MaxLevel)){
                                if(SPJsonArray[bestIndex][costCol(SPJsonArray[bestIndex], 0)] <= (startingSp - spSpent)){
                                    if(SPJsonArray[bestIndex].SPReq <= treeSp[SPJsonArray[bestIndex].Class]){
                                            toLevel = bestIndex;    
                                            bestIndex = 0;
                                            UpgradeAvailable = true; 
                                    } else {
                                        allocateBestAvailableOfTree(SPJsonArray[bestIndex].Class, SPJsonArray[bestIndex].SPReq);
                                        toLevel = bestIndex;    
                                        bestIndex = 0;
                                        UpgradeAvailable = true;
                                    }
                                }
                            }
                        }
                    }
                }
                if(UpgradeAvailable){
                    console.log("Satisfying Prereq By Leveling: ", SPJsonArray[toLevel].Name);
                    //checkPrerequesites(SPJsonArray[toLevel]);
                    levelSkill(SPJsonArray[toLevel], 1);
                } else if(bestIndex < SPJsonArray.length - 1){
                    bestIndex++;
                    UpgradeAvailable = true;
                } 
            }
            return true;
        };
        function checkPrerequesites(skillRow){
            if(Number(skillRow.Slot) == 0) return;
            var slot = Number(skillRow.Slot);
            var prereqslot = Math.max(0, slot - 3);
            var prereqSkillRow = findSlot(getTreeByClass(skillRow.Class), prereqslot);
            if(prereqSkillRow.Level == 0) {
                if(prereqSkillRow.Slot == 0) levelSkill(prereqSkillRow, 2);
                else levelSkill(prereqSkillRow, 1);
            }
            checkPrerequesites(prereqSkillRow);
            console.log(skillRow.Name, "prereq:", prereqSkillRow.Name);
        }
        function processHeroSkills(data){
            var allTextLines = data.split(/\r\n|\n/);
            var firstline = allTextLines[0].split(',');
            var headings = firstline.splice(0,firstline.length);
            for (var i = 1; i < allTextLines.length; i++ ) {
                var tarr = {};
                var currentLine = allTextLines[i].split(',');
                if(typeof heroSkills[currentLine[3]] !== "undefined"){
                    if(currentLine[4] > 1.0){
                        if(currentLine[3] == "ManaPoolCap") {
                            heroSkills[currentLine[3]] = heroSkills[currentLine[3]] + Number(currentLine[4]);
                        } else {
                        heroSkills[currentLine[3]] = heroSkills[currentLine[3]] + 1;
                        }
                    } else {
                        heroSkills[currentLine[3]] = heroSkills[currentLine[3]] + Number(currentLine[4]);
                    }
                } else {
                    if(currentLine[4] > 1.0){
                        if(currentLine[3] == "ManaPoolCap") {
                            heroSkills[currentLine[3]] = Number(currentLine[4]);
                        } else {
                            heroSkills[currentLine[3]] = 1;
                        }
                    } else {
                        heroSkills[currentLine[3]] = Number(currentLine[4]);
                    } 
                }
            }
            console.log(heroSkills);
        }
        function isSpecialEffiencySkill(skillName){
            if(SpecialEffieciencies.includes(skillName)) return true;
            return false;
        }
        var warcryHelpers = 1;
        function hasT4plusOne(Class){
            switch(Class){
                case "Knight":
                    return playerSets["Ignus, the Volcanic Phoenix"];
                break;
                case "Warlord" : return playerSets["Ironheart, the Crackling Tiger"];
                break;
                case "Rogue": return playerSets["Styxsis, the Single Touch"];
                break;
                case "Sorcerer": return playerSets["Kor, the Whispering Wave"];
                break;
            }
        }
        function CalculateSpecialEfficieny(skillName, A, Aplus, Aplusplus, B, Bplus, Bplusplus, cost, reduction, bonustype){
            const homRatio = Goldreductions[SelectedGoldOption][Gold.HoM];
            switch(skillName){
                    case "Astral Awakening":
                    if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Warlord") ? Math.pow(Aplusplus, 5) : Math.pow(Aplus, 5)), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow((Math.pow(hasT4plusOne("Warlord") ? Aplusplus : Aplus, 5)/Math.pow(hasT4plusOne("Warlord") ? Aplus : A, 5)), (1/cost)), reduction));
                    break; hasT4plusOne("Rogue")
                    case "Forbidden Contract":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Rogue") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow((hasT4plusOne("Rogue") ? Aplusplus : Aplus)/(hasT4plusOne("Rogue") ? Aplus : A), (1/cost)), reduction));
                        break;
                    case "Anchoring Shot":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Warlord") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow((hasT4plusOne("Warlord") ? Aplusplus : Aplus)/(hasT4plusOne("Warlord") ? Aplus : A), (1/cost)), reduction));
                        break;
                    case "Dagger Storm":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Rogue") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((Math.pow((hasT4plusOne("Rogue") ? Aplusplus : Aplus), (playerSets["Forsaken Battlemage"] ? 1 : 0) + hasT4plusOne("Rogue") ? Bplusplus: Bplus))/(Math.pow((hasT4plusOne("Rogue") ? Aplus : A), (playerSets["Forsaken Battlemage"] ? 1 : 0) + hasT4plusOne("Rogue") ? Bplus: B))), (1/cost)), reduction));
                        break;
                    break;
                    case "Deadly Focus":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Rogue") ? Aplusplus*Bplusplus : Aplus*Bplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((hasT4plusOne("Rogue") ? Aplusplus : Aplus) * (hasT4plusOne("Rogue") ? Bplusplus : Bplus))/((hasT4plusOne("Rogue") ? Aplus : A) * (hasT4plusOne("Rogue") ? Bplus : B)), (1/cost)), reduction));
                        break;
                    case "Volcanic Supremacy":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Knight") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((Math.pow((hasT4plusOne("Knight") ? Aplusplus : Aplus), (playerSets["Forsaken Battlemage"] ? 1 : 0) + hasT4plusOne("Warlord") ? Bplusplus: Bplus))/(Math.pow((hasT4plusOne("Knight") ? Aplus : A), (playerSets["Forsaken Battlemage"] ? 1 : 0) + hasT4plusOne("Warlord") ? Bplus: B))), (1/cost)), reduction));
                    break;
                    case "Barbaric Fury":{
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Knight") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((hasT4plusOne("Knight") ? Aplusplus : Aplus)/(hasT4plusOne("Knight") ? Aplus : A)), (1/cost)), reduction));
                        break;
                    }
                    case "Flash Zip":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Knight") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((hasT4plusOne("Knight") ? Aplusplus : Aplus)/(hasT4plusOne("Knight") ? Aplus : A)), (1/cost)), reduction));
                        break;
                    case "Command Supremacy":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Warlord") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((Math.pow((hasT4plusOne("Warlord") ? Aplusplus : Aplus), (playerSets["Forsaken Battlemage"] ? 1 : 0) + hasT4plusOne("Warlord") ? Bplusplus: Bplus))/(Math.pow((hasT4plusOne("Warlord") ? Aplus : A), (playerSets["Forsaken Battlemage"] ? 1 : 0) + hasT4plusOne("Warlord") ? Bplus : B))), (1/cost)), reduction));
                        break;
                    case "Dimensional Shift":
                        if(A == 0) return Number(Math.pow(Math.pow((hasT4plusOne("Sorcerer") ? Aplusplus : Aplus), (1/cost)), reduction));
                        return Number(Math.pow(Math.pow(((hasT4plusOne("Sorcerer") ? Aplusplus : Aplus)/(hasT4plusOne("Sorcerer") ? Aplus : A)), (1/cost)), reduction+homRatio));
                    break;
                    case "Lightning Strike":
                        function calculateLs(currentHealth, currentHealthReduction, staticEfficiency, strikesRemaining){
                            if(strikesRemaining <= 0) {
                               return Number(currentHealth);
                            }
                            var currentMultiplier = (currentHealthReduction*staticEfficiency);
                            currentHealth = Number(currentHealth+Math.log10(currentMultiplier));
                            return Number(calculateLs(currentHealth, currentMultiplier, staticEfficiency, strikesRemaining-1));
                        }
                        function calculateLsStrike(currentHealthReduction, staticEfficiency){
                            return calculateLs(0, (1-currentHealthReduction), staticEfficiency, ((playerProbabilities.lightningStrikePercent/100)*(playerProbabilities.lightningStrikeAttempts)*playerProbabilities.timeSpentOnBoss));
                        }
                        function calculateTotalMultiplier(skill1A, skill1B, skill2A, skill2B){
                            var total = Math.pow(10, calculateLsStrike(skill1A, skill1B) - calculateLsStrike(skill2A, skill2B));
                            return total;
                        }
                        if(A == 0) {
                            var total = Math.pow(10, playerSets["Kor, the Whispering Wave"] ? -calculateLsStrike(Aplusplus, Bplusplus) : -calculateLsStrike(Aplus, Bplus));
                            return Number(Math.pow(Math.pow(10, isNaN(total) ? 10 : total), (1/cost)));
                        }

                        return Number(Math.pow(hasT4plusOne("Sorcerer") ? calculateTotalMultiplier(Aplusplus, Bplusplus, Aplus, Bplus) : calculateTotalMultiplier(Aplus, Bplus, A, B), (1/cost)));
                    break;
                    case "Tactical Insight":
                        var nextLvlMult = 1;
                        var currLvlMult = 1;
                        const goldRatio = Goldreductions[SelectedGoldOption][Gold.All];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.GoldAll), goldRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.GoldAll), goldRatio);
                        const bossGoldRatio = Goldreductions[SelectedGoldOption][Gold.Boss];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.GoldBoss), bossGoldRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.GoldBoss), bossGoldRatio);
                        const chestGoldRatio = Goldreductions[SelectedGoldOption][Gold.Chesterson];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.ChestAmount), chestGoldRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.ChestAmount), chestGoldRatio);
                        const fairyGoldRatio = Goldreductions[SelectedGoldOption][Gold.Fairy];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.FairyGold), fairyGoldRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.FairyGold), fairyGoldRatio);
                        if(SelectedBuildDamage != BuildDamageOptions.Hero){
                            nextLvlMult = nextLvlMult * Math.pow(1+Aplus, heroSkillsCalced.CritDamage);
                            nextLvlMult = nextLvlMult * ((1 + Bplus) * (heroSkillsCalced.CritChance + (playerProbabilities.crit/100)));
                            currLvlMult = currLvlMult * Math.pow(1+A, heroSkillsCalced.CritDamage);
                            currLvlMult = currLvlMult * ((1 + B) * (heroSkillsCalced.CritChance + (playerProbabilities.crit/100)));
                        }
                        nextLvlMult = nextLvlMult * Math.pow(1+Aplus, heroSkillsCalced.AllDamage);
                        currLvlMult = currLvlMult * Math.pow(1+A, heroSkillsCalced.AllDamage);
                        const heroRatio = SPreductions[SelectedBuildDamage][Types.hero];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.AllHelperDamage + heroSkillsCalced.RangedHelperDamage), heroRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.AllHelperDamage + heroSkillsCalced.RangedHelperDamage), heroRatio);
                        const scRatio = SPreductions[SelectedBuildDamage][Types.sc];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.ShadowCloneSkillAmount), scRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.ShadowCloneSkillAmount), scRatio);
                        const tapRatio = SPreductions[SelectedBuildDamage][Types.tap];
                        nextLvlMult = nextLvlMult * Math.pow(Math.pow(1+Aplus, heroSkillsCalced.TapDamage), tapRatio);
                        nextLvlMult = nextLvlMult * Math.pow(1+Bplus, tapRatio);
                        currLvlMult = currLvlMult * Math.pow(Math.pow(1+A, heroSkillsCalced.TapDamage), tapRatio);
                        currLvlMult = currLvlMult * Math.pow(1+B, tapRatio);
                        return Number(Math.pow((nextLvlMult/currLvlMult), (1/cost)));
                    break;
                    case "Chivalric Order":
                        return Number(Math.pow(Math.pow(((Aplus + (playerSets.MastersSword ? .004 : 0) + (.0001 * (1+playerProbabilities.TiAdditivePerecent)))/(A + (playerSets.MastersSword ? .004 : 0) + (.0001 * (1+playerProbabilities.TiAdditivePerecent)))), (1/cost)), reduction));
                    break;
                    default:
                        break;
                }
                if(A == 0) A = 1; //FOR SKILLS THAT DONT GET +1s - Division by 0 Error fixes
                switch(skillName){
                    case "Warcry":
                        warcryHelpers = B;
                        levelSkill(SearingLight, 0);
                        return Number(Math.pow(Math.pow((Aplus/A), (1/cost)), reduction));
                        break;
                    case "Divine Surpremacy":
                        return Number(Math.pow(Math.pow(((Math.pow( Aplus, (playerSets["Forsaken Battlemage"] ? 1 : 0) + Bplus))/(Math.pow( A, (playerSets["Forsaken Battlemage"] ? 1 : 0) + B))), (1/cost)), reduction));
                        break;
                    case "Phantom Supremacy":
                        return Number(Math.pow(Math.pow(((Math.pow( Aplus, (playerSets["Forsaken Battlemage"] ? 1 : 0) + Bplus))/(Math.pow( A, (playerSets["Forsaken Battlemage"] ? 1 : 0) + B))), (1/cost)), reduction));
                        break;
                    case "Cleaving Strike":
                        var critExpo = SPreductions[SelectedBuildDamage][Types.critMult];
                        return Number(Math.pow(Math.pow(((Aplus/A)*(Math.pow((playerProbabilities.crit/100)+Bplus, critExpo)/Math.pow((playerProbabilities.crit/100)+B, critExpo))), (1/cost)), reduction));
                    break;
                    case "Searing Light":
                        if(startingSp > 600 && (SearingLight.Level < 7 && SearingLight.Level >= 1 )){
                            var levelInc = 8 - SearingLight.Level;
                            return Number(Math.pow(Math.pow((1+SearingLight[effectColA(SearingLight,levelInc)]*warcryHelpers*4*30)/(SearingLight[effectColA(SearingLight,levelInc-1)]*warcryHelpers*4*30), (1/SearingLight[costCol(SearingLight, levelInc-1)])), reduction));
                        }
                        return Number(Math.pow(Math.pow((1+Aplus*warcryHelpers*4*30)/(A == 0 || A == 1 ? 1 : 1+A*warcryHelpers*4*30), (1/cost)), reduction));
                    break;
                    case "Midas Ultimate":
                        const fairyRatio = Goldreductions[SelectedGoldOption][Gold.Fairy];
                        return Number(Math.pow(Math.pow(Math.pow((Aplus/A), homRatio)*Math.pow((Bplus/B), fairyRatio), (1/cost)), reduction));
                    break;
                    case "Phantom Vengeance":
                        return Number(Math.pow(Math.pow((Aplus/A)*((4+Bplus)/(4+B)), (1/cost)), reduction));
                    break;
                    case "Stroke Of Luck":
                        const companionRatio = SPreductions[SelectedBuildDamage][Types.companion];
                        const solgoldRatio = Goldreductions[SelectedGoldOption][Gold.All];
                        return Number(Math.pow(Math.pow((Aplus/A), companionRatio)*Math.pow((Bplus*1000)/(B == 0 ? 1 :(B*1000)),solgoldRatio), (1/cost)));
                        break;
                    default:
                        break;
                }
        }
        function calculateBaseEfficieny(skillRow){

            const bonustype = skillRow['BonusTypeA'];
            const currLvlEFfA = Number(skillRow[effectColA(skillRow, 0)]);
            const nextLvlEFfA = Number(skillRow[effectColA(skillRow, 1)]);
            const nextnextLvlEFfA = Number(skillRow[effectColA(skillRow, 2)]);
            const currLvlEFfB = Number(skillRow[effectColB(skillRow, 0)]);
            const nextLvlEFfB = Number(skillRow[effectColB(skillRow, 1)]);
            const nextnextLvlEFfB = Number(skillRow[effectColB(skillRow, 2)]);
            const nextLvlCost = Number(skillRow[costCol(skillRow, 0)]);
            var reductionAmt = 0;
            if(Gold.hasOwnProperty(bonustype)){
                reductionAmt = Number(Goldreductions[SelectedGoldOption][bonustype]);
            } else {
                reductionAmt = Number(SPreductions[SelectedBuildDamage][bonustype]);
            }
            if(isSpecialEffiencySkill(skillRow.Name)) return CalculateSpecialEfficieny(skillRow.Name, currLvlEFfA, nextLvlEFfA, nextnextLvlEFfA, currLvlEFfB, nextLvlEFfB, nextnextLvlEFfB, nextLvlCost, reductionAmt, bonustype);
            var eff = 0;
            if(skillRow.Level == 0){
                eff = Number(Math.pow(Math.pow((nextLvlEFfA), (1/nextLvlCost)), reductionAmt));
            } else {
                eff = Number(Math.pow(Math.pow((nextLvlEFfA/currLvlEFfA), (1/nextLvlCost)), reductionAmt));
            }
            return eff;
        }
        function calculateTreeTotal(tree, id){
            var spdiv = document.getElementById(id+"Sp");
            spdiv.parentElement.replaceChild(getTreeSpTotal(tree, id), spdiv);
            updateTotalSpSpent();
        }
        function updateTotalSpSpent(){
            var totalSoFar = 0;
            for(var key of Object.keys(treeSp)){
                totalSoFar += treeSp[key];
            }
            document.getElementById('spSpent').value = totalSoFar;
            spSpent = totalSoFar;
        }
        function getTreeSpTotal(tree, id){
            var totalSpent = document.createElement('div');
            totalSpent.classList = "treeSp";
            totalSpent.id = id+"Sp";
            var totalSoFar = 0;
            for(var i = 0; i < tree.length; i++){
                totalSoFar += Number(tree[i]["CummulativeSP"]);
            };
            totalSpent.textContent = totalSoFar;
            treeSp[tree[0]['Class']] = totalSoFar;
            return totalSpent;
        }
        function getCummaltiveSpForSkill(skillrow){
            var costSoFar = 0;
            function costCol(level){
                return "Co"+level;
            }
            for(var i = 0; i < skillrow.Level; i++){
                costSoFar += Number(skillrow[costCol(i)]);
            }
            return costSoFar;
        }
        function levelSkill(skillRow, levelIncrement){
            if(skillRow.Level + levelIncrement <= skillRow.MaxLevel || skillRow.Level + levelIncrement >= 0) {
                skillRow.Level = skillRow.Level + levelIncrement;
            }
            skillRow["CummulativeSP"] = getCummaltiveSpForSkill(skillRow);
            calculateTreeTotal(getTreeByClass(skillRow.Class), TreeIDTagByClass[skillRow.Class]);
            skillRow["Efficiency"] = calculateBaseEfficieny(skillRow);
            var oldCell = document.getElementById(skillRow["Class"]+skillRow["Slot"]);
            oldCell.parentElement.replaceChild(createSkillCell(skillRow), oldCell);
            playerProbabilities.TiAdditivePerecent = TI["A"+TI.Level];
            playerProbabilities.TiMultiplicativePerecent = TI["B"+TI.Level];
            updateSkillRankingList();
        }
        function createSkillCell(skillrow){
            var div = document.createElement('div');
            if(typeof skillrow !== 'undefined'){
                var tree = getTreeByClass(skillrow.Class);
                var id = skillrow.Slot;
                div.id = skillrow.Class+id;
                var levelup = levelUpButton.cloneNode(true);
                if(skillrow.Level == 0){
                    skillrow["Efficiency"] = calculateBaseEfficieny(skillrow);
                    skillrow["CummulativeSP"] = getCummaltiveSpForSkill(skillrow);
                }
                levelup.onclick = function (){ 
                    if(skillrow.Level == skillrow.MaxLevel) return;
                    levelSkill(skillrow, 1);
                };
                var leveldown = levelDownButton.cloneNode(true);
                leveldown.onclick = function (){ 
                    if(skillrow.Level == 0) return;
                    levelSkill(skillrow, -1);
                };
                var ignore = document.createElement('Button');
                ignore.textContent = "On";
                ignore.className = "ignoreButton";
                if(skillrow.Ignore){
                    ignore.textContent = "OFF";
                    ignore.className = "ignoreButton ignored"
                } else {
                    ignore.textContent = "ON";
                    ignore.className = "ignoreButton active"
                }
     
                ignore.onclick = function (){ 
                    skillrow.Ignore = !skillrow.Ignore;
                    var parent = div.parentElement;
                    parent.replaceChild(createSkillCell(skillrow), div);
                    updateSkillRankingList();
                    //console.log(SPJsonArray);
                    //calculateTreeTotal(tree, Trees[skillrow.Class]);
                };
                var levelamt =  document.createElement('div');
                levelamt.textContent = skillrow.Level;
                var leveldiv =  document.createElement('div');
                leveldiv.className = 'skillCellLevel';
                leveldiv.appendChild(levelup);
                leveldiv.appendChild(levelamt);
                leveldiv.appendChild(leveldown);
                if(skillrow.TierNum == 4 && skillrow.Level > 0 && hasT4plusOne(skillrow.Class)){
                    var plusOne = document.createElement('div');
                    plusOne.textContent = ""+(skillrow.Level+1)+"";
                    var single = "";
                    if(skillrow.Level < 9) single = " plusOneSingleVal";
                    plusOne.className = "plusOne plusOne"+skillrow.Class + single;
                    leveldiv.appendChild(plusOne);
                }    
                div.appendChild(leveldiv)
                var namediv =  document.createElement('div');
                namediv.textContent = skillrow.Name;
                namediv.className = 'skillCellName';
                var effdiv =  document.createElement('div');
                var eff = skillrow["Efficiency"];
                if(skillrow.Level == skillrow.MaxLevel){
                    eff = "MAX";
                    effdiv.textContent = eff;
                } else {
                  effdiv.textContent = Number(eff).toFixed(4);;  
                }
                effdiv.className = 'skillCellEff';
                namediv.appendChild(effdiv);
                namediv.appendChild(ignore);
                
                div.appendChild(namediv)
                div.className = 'skillCell skillCell'+skillrow.Class+ ' firstRow';
            } else {
                div.className = 'skillCell skillCell empty'; 
            }
            return div;
        }
        function findSlot(tree, slot){
            for(var i = 0; i < tree.length; i++){
                if(tree[i].Slot == slot+"") return tree[i];
            }
        }
        function populateTree(id, tree){
            tree.length = 0;
            for(var i = 0; i < SPJsonArray.length; i++){
                if(SPJsonArray[i].Class == id) tree.push(SPJsonArray[i]);
            }
        }
        function createTree(id, treeArray){
            // var thisTree = document.getElementById(id);
            // thisTree.innerHTML = "";
            var thisTree = document.createDocumentFragment();
            var totalSpent = document.createElement('div');
            totalSpent.textContent = "0";
            totalSpent.classList = "treeSp";
            totalSpent.id = id+"Sp"
            var firstRow = document.createElement('div');
            var i = 0;
            thisTree.append(totalSpent);
            var div = createSkillCell(findSlot(treeArray, i++));
            firstRow.appendChild(div);
            thisTree.append(firstRow);
            var secondRow = document.createElement('div');
            secondRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            secondRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            secondRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            thisTree.append(secondRow);
            var thirdRow = document.createElement('div');
            thirdRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            thirdRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            thirdRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            thisTree.append(thirdRow);
            var fourthRow = document.createElement('div');
            fourthRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            fourthRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            fourthRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            thisTree.append(fourthRow);
            var fifthRow = document.createElement('div');
            fifthRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            fifthRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            fifthRow.appendChild(createSkillCell(findSlot(treeArray, i++)));
            thisTree.append(fifthRow);
            document.getElementById(id).innerHTML = "";
            document.getElementById(id).append(thisTree);
            if(id == "rogueTree"){
                var parrotInfo = document.createElement('div');
                parrotInfo.className = "parrotInfo";
                parrotInfo.innerText = "Discord: Parrot6#7225\nReddit: u/Killerparrot6\nVenmo: Parrot6"
                document.getElementById(id).append(parrotInfo);
            }
            calculateTreeTotal(treeArray, id);
            function checkIfSkipSlot(){
                if(treeArray[i].Slot > i) return true;
            }
            //calculateTreeTotals(treeArray);
        }
        function processReductions(allReductions){
            var allTextLines = allReductions.split(/\r\n|\n/);
            var headings = allTextLines[0].split(',');

            var headings = headings.splice(0,headings.length);
            for (var i = 1; i < allTextLines.length; i++ ) {
                var tarr = {};
                var currentLine = allTextLines[i].split(',');
                for (var j=0; j<headings.length; j++) {
                    if(j>=1){
                        tarr[headings[j].trim()] = eval(currentLine[j].trim());
                    }else{
                        tarr[headings[j].trim()] = currentLine[j].trim();
                    }
                }
                SPreductions[tarr.Source] = tarr;
            }
        }
        function processGoldReductions(allReductions){
            var allTextLines = allReductions.split(/\r\n|\n/);
            var headings = allTextLines[0].split(',');

            var headings = headings.splice(0,headings.length);
            for (var i = 1; i < allTextLines.length; i++ ) {
                var tarr = {};
                var currentLine = allTextLines[i].split(',');
                for (var j=0; j<headings.length; j++) {
                    if(j>=1){
                        tarr[headings[j].trim()] = eval(currentLine[j].trim());
                    }else{
                        tarr[headings[j].trim()] = currentLine[j].trim();
                    }
                }
                Goldreductions[tarr.Types] = tarr;
            }
        }
        function getTreeByClass(classname){
            switch(classname){
                case "Knight":
                return knightArray;
                break;
                case "Warlord":
                return warlordArray;
                break;
                case "Sorcerer":
                return sorcererArray;
                break;
                case "Rogue":
                return rogueArray;
                break;
                default:
                    console.log("Fell off branch")
                break;
            }
        }
        function processData() { 
            allText = initialTreeData;
            var allTextLines = allText.split(/\r\n|\n/);
            var headings = allTextLines[0].split(',');
            SPJsonArray = [];
            var headings = headings.splice(0,headings.length);
            var pv = 0;
            for (var i = 1; i < allTextLines.length; i++ ) {
                var tarr = {};
                tarr["Level"] = 0;
                var currentLine = allTextLines[i].split(',');
                for (var j=0; j<headings.length; j++) {
                    tarr[headings[j]] = currentLine[j].trim();
                }
                if(typeof nameConversions[tarr['Name']] !== 'undefined') {
                    if(tarr['Name'] == "Phantom Vengeance" && pv < 1) {
                        pv++
                    } else {
                        tarr['Name'] = nameConversions[tarr['Name']];
                    }
                }
                
                if(typeof typeConversions[tarr['BonusTypeA']] == 'undefined') console.log("UNDEFINED" + tarr['BonusTypeA'])
                tarr['BonusTypeA'] = typeConversions[tarr['BonusTypeA']];
                tarr['Ignore'] = false;
                SPJsonArray.push(tarr);
                if(tarr['Name'] == "Tactical Insight"){
                            TI = tarr;
                }
                if(tarr['Name'] == "Searing Light"){
                            SearingLight = tarr;
                }
            }
            
            console.log(SPJsonArray);
            populateTree("Knight", knightArray);
            populateTree("Warlord", warlordArray);
            populateTree("Sorcerer", sorcererArray);
            populateTree("Rogue", rogueArray);
            var temp = document.createDocumentFragment();
            for(var key of Object.keys(BuildDamageOptions)){
                var opt = document.createElement('option');
                opt.value = BuildDamageOptions[key];
                opt.innerHTML = BuildDamageOptions[key];
                temp.appendChild(opt);
            }
            document.getElementById('buildDmgType').appendChild(temp);
            document.getElementById('buildDmgType').onchange = function(e){
                    ChangeDamageType();
                    refreshSkills();
                }
            var temp = document.createDocumentFragment();
            for(var key of Object.keys(BuildGoldOptions)){
                var opt = document.createElement('option');
                opt.value = BuildGoldOptions[key];
                opt.innerHTML = BuildGoldOptions[key];
                temp.appendChild(opt);       
            }
            document.getElementById('buildGoldType').appendChild(temp);
            document.getElementById('buildGoldType').onchange = function(e){
                    ChangeGoldType();
                    refreshSkills();
                }
            updateProbabilites();
            updateEquipments();
            initializeQuickRenderTemplates();
            Reload();
        }
        function initializeQuickRenderTemplates(){
            levelUpButton = document.createElement('Button');
            levelUpButton.className = 'levelButton levelUpButton';
            levelUpButton.innerHTML = '&#9650';
            levelDownButton = document.createElement('Button');
            levelDownButton.className = 'levelButton levelDownButton';
            levelDownButton.innerHTML = '&#9660';
            rankingBoxRankTemplate = document.createElement('div');
            rankingBoxRankTemplate.classList = "SkillRankingRank";
            rankingBoxNameTemplate = document.createElement('div');
            rankingBoxNameTemplate.classList = "SkillRankingName";
            rankingBoxValueTemplate = document.createElement('div');
            rankingBoxValueTemplate.classList = "SkillRankingValue";
            rankingBoxRowKnight = document.createElement('div');
            rankingBoxRowKnight.classList = "skillRankingRow KnightToLevel";
            rankingBoxRowWarlord = document.createElement('div');
            rankingBoxRowWarlord.classList = "skillRankingRow WarlordToLevel";
            rankingBoxRowSorcerer = document.createElement('div');
            rankingBoxRowSorcerer.classList = "skillRankingRow SorcererToLevel";
            rankingBoxRowRogue = document.createElement('div');
            rankingBoxRowRogue.classList = "skillRankingRow RogueToLevel";
        }
        function getRowTemplate(Class){
            switch (Class){
                case "Knight":
                return rankingBoxRowKnight;
                case "Warlord":
                return rankingBoxRowWarlord;
                case "Sorcerer":
                return rankingBoxRowSorcerer;
                case "Rogue":
                return rankingBoxRowRogue;
                default:
                    console.log("fell off switch")
                    break;
            }
        }
        function ChangeDamageType(){
            SelectedBuildDamage = buildDmgType.value;
        }
        function ChangeGoldType(){
            SelectedGoldOption = buildGoldType.value;
        }
        function Reload(){
            $('#buildDmgType').val(SelectedBuildDamage);
            $('#buildGoldType').val(SelectedGoldOption);
            createTree(TreeIDTagByClass.Knight, knightArray);
            createTree(TreeIDTagByClass.Warlord, warlordArray);
            createTree(TreeIDTagByClass.Sorcerer, sorcererArray);
            createTree(TreeIDTagByClass.Rogue, rogueArray);
            updateTotalSpSpent();
            updateSkillRankingList();
        }
        function refreshSkills(){
            SPJsonArray.forEach((element)=>{
                levelSkill(element, 0);
            });
        }
        function resetTree(){
            SPJsonArray.forEach(element => {
                element.Level = 0;
            })
            Reload();
        }
        function loadSkillsFrom(thisList){
            resetTree();
            Object.entries(thisList).forEach(([key, value]) => {
                for(var i = 0; i < SPJsonArray.length; i++){
                    if(SPJsonArray[i].Name == key){
                        levelSkill(SPJsonArray[i], value);
                        break;
                    }
                }
            });  
        }
        function updateProbabilites(){
            var probsContainer = Probabilities;
            probsContainer.innerHTML = "";
            function getNewProb(labelText, inputText, valToUpdate){
                var newProb = document.createElement('div');
                newProb.classList = "row no-gutters";
                var newLabel = document.createElement('div');
                newLabel.classList = "col-md-12 col-lg-auto alignLabelVert";
                var label = document.createElement('label');
                label.textContent = labelText;
                newLabel.appendChild(label);
                newProb.appendChild(newLabel);
                var newInput = document.createElement('div');
                newInput.classList = "col";
                var input = document.createElement('input');
                input.value = inputText;
                input.type = "number";
                input.max = "100";
                input.min = "0";
                input.onchange = function(){
                    playerProbabilities[valToUpdate] = Number(input.value);
                }
                newInput.appendChild(input);
                newProb.appendChild(newInput);
                return newProb;
            }
            probsContainer.appendChild(getNewProb("Time Spent:", "30", "timeSpentOnBoss"));
            probsContainer.appendChild(getNewProb("LS %:", "2.0", "lightningStrikePercent"));
            probsContainer.appendChild(getNewProb("LS Attempts/s:", "100.0", "lightningStrikeAttempts"));
            probsContainer.appendChild(getNewProb("Crit%:", "100", "crit"));
            probsContainer.appendChild(getNewProb("Deadly%:", "100", "deadly"));
            probsContainer.appendChild(getNewProb("Spawn%:", "100", "multispawn"));
            // Object.entries(playerProbabilities).forEach(([key, value]) => {
            //     var newItem = document.createElement('div');
            //     newItem.textContent = key +": "+ value;
            //     probsContainer.appendChild(newItem);
            // });         
        };
        function updateEquipments(){
            function getNewEquip(labelText, valToUpdate){
                var newProb = document.createElement('div');
                newProb.classList = "row no-gutters";
                var newLabel = document.createElement('div');
                newLabel.classList = "col-12 alignLabelVert";
                var label = document.createElement('label');
                label.textContent = labelText;
                label.style.width = "100%";
                newLabel.appendChild(label);
                newProb.appendChild(newLabel);
                var newInput = document.createElement('div');
                newInput.classList = "col";
                var input = document.createElement('select');
                var option1 = document.createElement('option');
                option1.value = true;
                option1.textContent = "Obtained";
                var option2 = document.createElement('option');
                option2.value = false;
                option2.textContent = "Not Owned";
                input.style.marginBottom = "2px";
                input.appendChild(option1);
                input.appendChild(option2);
                input.onchange = function(){
                    function checkBool(string){
                        switch(string) {case "false": case "no": case "0": case "": return false; default: return true;};
                    }
                    var boole = checkBool(this.value.toLowerCase());
                    playerSets[valToUpdate] = boole;
                }
                newInput.appendChild(input);
                newProb.appendChild(newInput);
                return newProb;
            }
            var probsContainer = EquipmentSets;
            Object.entries(playerSets).forEach(([key, value]) => {
                probsContainer.appendChild(getNewEquip(key, key));
            });         
        };
        function updateArtifacts(){
            function getNewArtifact(labelText){
                var newProb = document.createElement('div');
                newProb.classList = "row no-gutters";
                var newLabel = document.createElement('div');
                newLabel.classList = "col-12 alignLabelVert";
                var label = document.createElement('label');
                label.textContent = labelText;
                label.style.width = "100%";
                newLabel.appendChild(label);
                newProb.appendChild(newLabel);
                var newInput = document.createElement('div');
                newInput.classList = "col";
                var input = document.createElement('select');
                var option1 = document.createElement('option');
                option1.value = true;
                option1.textContent = "Obtained";
                var option2 = document.createElement('option');
                option2.value = false;
                option2.textContent = "Not Owned";
                input.style.marginBottom = "2px";
                input.appendChild(option1);
                input.appendChild(option2);
                input.onchange = function(){
                    function checkBool(string){
                        switch(string) {case "false": case "no": case "0": case "": return false; default: return true;};
                    }
                    var boole = checkBool(this.value.toLowerCase());
                    playerSets[labelText] = boole;
                }
                newInput.appendChild(input);
                newProb.appendChild(newInput);
                return newProb;
            }
            var probsContainer = EquipmentSets;
            probsContainer.innerHTML = "";
            if(typeof playerArtifacts["The Master's Sword"] !== undefined){
                probsContainer.appendChild(getNewArtifact("The Master's Sword"));
            }      
        };
    </script>
       <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  
</html>